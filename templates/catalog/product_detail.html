{% extends 'base.html' %}

{% block title %}{{ product.name }} - Fashion Store{% endblock %}

{% block content %}
<div class="container">
    <div class="product-detail-grid">
        <div class="product-detail-images">
            {% if product.images.first %}
            <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}" class="product-main-image">
            {% else %}
            <div class="product-main-image product-main-image-placeholder">üëï</div>
            {% endif %}
            {% if product.images.all|length > 1 %}
            <div class="product-thumbnails">
                {% for image in product.images.all %}
                <img src="{{ image.image.url }}" alt="{{ product.name }}" class="product-thumb">
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <div class="product-detail-info">
            <h1 class="product-detail-title">{{ product.name }}</h1>
            {% if product.brand %}
            <p class="product-detail-brand">by {{ product.brand.name }}</p>
            {% endif %}
            <div class="product-detail-pricing">
                <span class="product-detail-price">‚Çπ{{ product.price }}</span>
                {% if product.compare_price and product.discount_percentage %}
                <span class="product-detail-compare">‚Çπ{{ product.compare_price }}</span>
                <span class="product-detail-discount">-{{ product.discount_percentage }}%</span>
                {% endif %}
            </div>
            <p class="product-detail-desc">{{ product.description }}</p>
            <div style="margin-bottom: 1.5rem;">
                </div>
                <style>
                    .product-detail-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 3rem;
                        margin-top: 2rem;
                    }
                    .product-detail-images {
                        display: flex;
                        flex-direction: column;
                        gap: 1.5rem;
                    }
                    .product-main-image {
    width: 100%;
    max-height: 420px;
    height: auto;
    object-fit: contain;
    background: #f7fafc;
    padding: 1rem;
    border-radius: 14px;
}
                    .product-main-image-placeholder {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 5rem;
                        color: #fff;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        height: 420px;
                        border-radius: 14px;
                    }
                    .product-thumbnails {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 0.5rem;
                    }
                    .product-thumb {
                        width: 100%;
                        height: 80px;
                        object-fit: cover;
                        border-radius: 8px;
                        cursor: pointer;
                        border: 2px solid transparent;
                        transition: border 0.2s;
                    }
                    .product-thumb:hover {
                        border: 2px solid #667eea;
                    }
                    .product-detail-info {
                        display: flex;
                        flex-direction: column;
                        gap: 1.5rem;
                    }
                    .product-detail-title {
                        font-size: 2.5rem;
                        margin-bottom: 0.5rem;
                        color: #2d3748;
                        font-weight: 700;
                    }
                    .product-detail-brand {
                        color: #718096;
                        font-size: 1.2rem;
                        margin-bottom: 1rem;
                    }
                    .product-detail-pricing {
                        margin-bottom: 1.5rem;
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                    }
                    .product-detail-price {
                        font-size: 2.5rem;
                        color: #667eea;
                        font-weight: bold;
                    }
                    .product-detail-compare {
                        text-decoration: line-through;
                        color: #a0aec0;
                        font-size: 1.5rem;
                    }
                    .product-detail-discount {
                        background: #f56565;
                        color: white;
                        padding: 0.5rem 1rem;
                        border-radius: 5px;
                        font-size: 1rem;
                        font-weight: 600;
                    }
                    .product-detail-desc {
                        color: #4a5568;
                        line-height: 1.8;
                        margin-bottom: 1.5rem;
                    }
                    @media (max-width: 992px) {
                        .product-detail-grid {
                            grid-template-columns: 1fr;
                            gap: 2rem;
                        }
                        .product-main-image, .product-main-image-placeholder {
                            height: 320px;
                        }
                    }
                    @media (max-width: 576px) {
                        .product-detail-title {
                            font-size: 1.6rem;
                        }
                        .product-detail-price {
                            font-size: 1.5rem;
                        }
                        .product-main-image, .product-main-image-placeholder {
                            height: 180px;
                        }
                        .product-thumbnails {
                            grid-template-columns: repeat(2, 1fr);
                        }
                    }
                </style>
                <!--
                <div id="live-user-count" style="margin-bottom: 1rem; color: #3182ce; font-weight: bold;">
                    <span>Live viewers: <span id="live-count">1</span></span>
                </div>
                {% block extra_js %}
                <script>
                    (function() {
                        var productId = {{ product.id }};
                        var countSpan = document.getElementById('live-count');
                        var wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
                        var wsPath = wsScheme + '://' + window.location.host + '/ws/product/' + productId + '/';
                        var socket = new WebSocket(wsPath);

                        socket.onmessage = function(e) {
                            var data = JSON.parse(e.data);
                            if (data.count !== undefined) {
                                countSpan.textContent = data.count;
                            }
                        };

                        socket.onclose = function(e) {
                            // Optionally handle disconnect
                        };
                    })();
                </script>
                {% endblock %}
                <strong>Category:</strong> {{ product.category.name }}
            </div>
        -->
            
            {% if product.material %}
            <div style="margin-bottom: 1.5rem;">
                <strong>Material:</strong> {{ product.material }}
            </div>
            {% endif %}
            
            <div style="margin-bottom: 2rem;">
                {% if product.stock_quantity > 0 %}
                <span style="color: #48bb78; font-weight: bold;">‚úì In Stock ({{ product.stock_quantity }} available)</span>
                {% else %}
                <span style="color: #f56565; font-weight: bold;">‚úó Out of Stock</span>
                {% endif %}
            </div>
            
            {% if product.variants.exists %}
            <form method="post" action="{% url 'cart:add_to_cart' product.id %}" style="margin-bottom: 2rem;">
                {% csrf_token %}
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Select Variant:</label>
                    <select name="variant_id" class="form-control" required>
                        <option value="">Choose size and color...</option>
                        {% for variant in product.variants.all %}
                        {% if variant.is_active and variant.stock_quantity > 0 %}
                        <option value="{{ variant.id }}">
                            {{ variant.size.name }} - {{ variant.color.name }} 
                            (Stock: {{ variant.stock_quantity }}) 
                            {% if variant.price_adjustment != 0 %}
                            - ‚Çπ{{ variant.final_price }}
                            {% endif %}
                        </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Quantity:</label>
                    <input type="number" name="quantity" value="1" min="1" max="100" class="form-control" style="width: 120px;">
                </div>
                
                {% if user.is_authenticated and product.stock_quantity > 0 %}
                <button type="submit" class="btn" style="width: 100%; margin-bottom: 1rem; padding: 1rem; font-size: 1.1rem; font-weight: bold;">üõí Add to Cart</button>
                {% elif product.stock_quantity == 0 %}
                <button type="button" class="btn" style="width: 100%; margin-bottom: 1rem; padding: 1rem; font-size: 1.1rem; font-weight: bold; background: #cbd5e0; cursor: not-allowed;" disabled>Out of Stock</button>
                {% else %}
                <a href="{% url 'customers:login' %}?next={{ request.path }}" class="btn" style="display: block; width: 100%; text-align: center; margin-bottom: 1rem; padding: 1rem; font-size: 1.1rem; font-weight: bold; text-decoration: none;">Login to Purchase</a>
                {% endif %}
            </form>
            {% else %}
            <form method="post" action="{% url 'cart:add_to_cart' product.id %}" style="margin-bottom: 2rem;">
                {% csrf_token %}
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Quantity:</label>
                    <input type="number" name="quantity" value="1" min="1" max="100" class="form-control" style="width: 120px;">
                </div>
                
                {% if user.is_authenticated and product.stock_quantity > 0 %}
                <button type="submit" class="btn" style="width: 100%; margin-bottom: 1rem; padding: 1rem; font-size: 1.1rem; font-weight: bold;">üõí Add to Cart</button>
                {% elif product.stock_quantity == 0 %}
                <button type="button" class="btn" style="width: 100%; margin-bottom: 1rem; padding: 1rem; font-size: 1.1rem; font-weight: bold; background: #cbd5e0; cursor: not-allowed;" disabled>Out of Stock</button>
                {% else %}
                <a href="{% url 'customers:login' %}?next={{ request.path }}" class="btn" style="display: block; width: 100%; text-align: center; margin-bottom: 1rem; padding: 1rem; font-size: 1.1rem; font-weight: bold; text-decoration: none;">Login to Purchase</a>
                {% endif %}
            </form>
            {% endif %}
            
            {% if user.is_authenticated %}
            <a href="{% url 'cart:add_to_wishlist' product.id %}" class="btn btn-secondary" style="width: 100%; text-align: center;">‚ù§Ô∏è Add to Wishlist</a>
            {% endif %}
            
            {% if product.care_instructions %}
            <div style="margin-top: 2rem; padding: 1.5rem; background: #f7fafc; border-radius: 8px;">
                <strong style="display: block; margin-bottom: 0.5rem;">Care Instructions:</strong>
                <p style="color: #4a5568;">{{ product.care_instructions }}</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    {% if approved_reviews or can_review %}
    <div style="margin-top: 4rem;">
        <h2 style="font-size: 2rem; margin-bottom: 2rem;">Customer Reviews</h2>
        
        {% if can_review %}
        <div class="card" style="background: #f7fafc; border: 2px dashed #667eea; margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1rem;">Write a Review</h3>
            <p style="color: #718096; margin-bottom: 1.5rem;">Share your experience with this product</p>
            
            <form method="post" action="{% url 'catalog:add_review' product.slug %}">
                {% csrf_token %}
                
                <div class="form-group">
                    <label style="font-weight: bold;">Rating *</label>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        {% for i in "12345" %}
                        <label style="cursor: pointer; font-size: 2rem;">
                            <input type="radio" name="rating" value="{{ forloop.counter }}" required style="display: none;">
                            <span class="star-rating" data-value="{{ forloop.counter }}">‚òÜ</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="form-group">
                    <label style="font-weight: bold;">Review Title *</label>
                    <input type="text" name="title" class="form-control" required maxlength="200" 
                           placeholder="Sum up your experience">
                </div>
                
                <div class="form-group">
                    <label style="font-weight: bold;">Your Review *</label>
                    <textarea name="comment" class="form-control" required rows="4" 
                              placeholder="Tell us what you think about this product"></textarea>
                </div>
                
                <button type="submit" class="btn" style="padding: 0.8rem 2rem;">Submit Review</button>
            </form>
        </div>
        
        <script>
        document.querySelectorAll('.star-rating').forEach(star => {
            star.addEventListener('click', function() {
                const rating = parseInt(this.dataset.value);
                const parent = this.closest('.form-group');
                parent.querySelectorAll('.star-rating').forEach((s, idx) => {
                    s.textContent = idx < rating ? '‚òÖ' : '‚òÜ';
                    s.style.color = idx < rating ? '#fbbf24' : '#cbd5e0';
                });
                this.parentElement.querySelector('input').checked = true;
            });
        });
        </script>
        {% endif %}
        
        {% for review in approved_reviews %}
        <div class="card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                <strong>{{ review.customer_name }}</strong>
                <span style="color: gold;">{% for i in "12345"|slice:":" %}{% if forloop.counter <= review.rating %}‚≠ê{% endif %}{% endfor %}</span>
            </div>
            <h4 style="margin-bottom: 0.5rem;">{{ review.title }}</h4>
            <p style="color: #4a5568;">{{ review.comment }}</p>
            {% if review.is_verified_purchase %}
            <span class="badge badge-success" style="margin-top: 0.5rem;">‚úì Verified Purchase</span>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if related_products %}
    <div style="margin-top: 4rem;">
        <h2 style="font-size: 2rem; margin-bottom: 2rem; text-align: center;">Related Products</h2>
        <div class="product-grid">
            {% for related in related_products %}
            <div class="product-card">
                <a href="{% url 'catalog:product_detail' related.slug %}" style="text-decoration: none; color: inherit;">
                    {% if related.images.first %}
                    <img src="{{ related.images.first.image.url }}" alt="{{ related.name }}" class="product-image">
                    {% else %}
                    <div class="product-image" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">üëï</div>
                    {% endif %}
                    <div class="product-info">
                        <h3 class="product-title">{{ related.name }}</h3>
                        <span class="product-price">‚Çπ{{ related.price }}</span>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
